---
title: 'Frequentist Analysis: Experiment 1'
author: "Myfanwy Johnston, Neil Willits"
date: "August 23, 2016"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

## Data Exploration, Experiment 1

First, a summary of the response variable and a plot of its distribution:

```{r datachunk, cache=TRUE, echo=FALSE, message=FALSE}
d <- read.csv("~/Dropbox/GitHubRepos/gst_rheo/data_tidy/gst_rheo_all.csv", header=T, stringsAsFactors = F)
d <- d[d$Type == "with", ]
d <- d[d$TrialNo != 15, ] # exclude 2nd trial of fish #20.
summary(d$PropPos)
plot(density(d$PropPos), main="PropPos")
```

## Modeling Experiment 1

These experiments were originally conceived with a Latin Square design: 24 fish and 4 Treatments = 6 Latin Squares.  A Latin Square design makes very efficient use of the individuals (fish, in this case) that are in an analysis, since by using a fish multiple times and partitioning off a (categorical) fish effect, the error term we're using represents within-fish variability, which is apt to be considerably smaller than the between-fish variability that would be used as an error term in a randomized block design. However, to do this, we need to assume that there are no orderXtreatment or orderXfish effects, which is a fairly strong assumption, and so it should be checked as part of running this type of analysis.  Additionally, we need to exclude the one fish of the 23 that was run through each treatment twice, so that we don't face issues with pseudoreplication.

After first running the model on the raw response variable, the residuals failed a Shapiro-Wilks test (W = 0.93).  As a result, we've used the following transformation of the response before continuing:


```{r transform, cache=TRUE}
## Transform PropPos 
d$PropPosTransform <- log((d$PropPos + .005)/(1-d$PropPos + .005))

```

Now we can construct the model and perform tests of our assumptions that the residual errors are normal, and that the assumption of constant variance is valid (using a Levene test).  The model structure is:

Y ~ square/fish + order + treatment

Where Y is our response variable (proportion of time spent positively oriented in a given treatment), square is the Latin Square to which that trial belongs (included to account for temporal variation), nested within individual fish (so that the model accounts for within-fish variation across squares).  Order and Treatment are then included as main effects.


```{r modelprep, cache=TRUE, echo=FALSE}

d$FishID2 <- as.factor(d$FishID)
d$Order2 <- as.factor(d$Order)
d$TrialNo2 <- as.factor(d$TrialNo)
d$Square <- as.factor(as.integer((d$TrialNo + 3.5)/4))
d$Treatment <- as.factor(d$Treatment)
```

```{r model, cache=TRUE}
m1 <- lm(PropPosTransform ~ Square/FishID2 + Order2 + Treatment, data = d)

anova(m1)
shapiro.test(m1$residuals)

```

We consider this result to be acceptable, since the value of the test statistic is high (W > .95, which is a somewhat arbitrary cutoff). The test statistic is equivalent to a correlation that’s based on a normal probability plot, so when this value is close to one, it means that there’s a close correspondence between the error distribution and a normal distribution. That’s where the Central Limit Theorem comes in, since with a W-value this high, the ANOVA’s F-statistics will behave as if the data were normal, even if they’re not exactly normal.

```{r Levene, cache=TRUE}
# run a levene test:  
m1Levene <- lm(abs(m1$residuals) ~ Square/FishID2 + Order2 + Treatment, data = d)
anova(m1Levene) # slight significance; means that there is more variance in some treatments than others. 
```

The output of the Levene test is an ANOVA table, which contains a series of p-values (one for each term in the model). This causes the overall error rate to be inflated, so we will use a Bonferroni adjustment, comparing each p-value against .05/k, where k is the number of terms in the ANOVA table:

```{r Bonferroni}
0.05/4 
```

At this new significance level, the only terms that change are the Square and Square/FishID term, which become slightly more significant.

At this point, we have satisfied normality and constant variance assumptions.  Treatment, Order, and variation due to temporal variability (represented by Square) and individual fish remain significant predictors of the time spent positively oriented during a given trial.

