{
    "collab_server" : "",
    "contents" : "## GST Rheotaxis Experiment 2: Barbel Trials\n\n# Author: Myfanwy Johnston\n# Date: April 5, 2016\n# Note: all models were run with multiple chains the first time around\n\n# Lines 16 - 37: Data loading and preparation\n# Lines 40 - 147: Experimental Models for Barbel Trials\n# Lines 148 - 170: Model comparison for Barbel Trials\n# Lines 172 - 403: Data and experimental models for before/after barbelectomy comparison\n# Lines 403 - end: Model comparison, exploration, prediction simulations, and visualizations for before/after barbelectomy comparison\n\n# Required packages:\nlibrary(rethinking) # version 1.55\nlibrary(rstan) # version 2.9.0-3\nlibrary(beepr)\n## Load and prep data ##\n#------------------------------------------------------------------------\nd <- read.csv(\"../data_tidy/gst_rheo_all.csv\", stringsAsFactors = FALSE, header = TRUE)\n## Filter data to include trials without barbels\n# d3 <- dplyr::filter(d, Type == \"without\") #uncomment for dplyr method\nd3 <- d[d$Type == \"without\", ]\n\n## Check for zeros\ny <- d3$PropPos\nrange(y)\nsum( dbeta2( y , 0.5 , 10 , log=TRUE ) )\ndens(d3$PropPos) # See shape of raw data; highly skewed, not as bi-modal as Exp 1; much more positive rheotaxis displayed in this group\n\n# Create dummy variables for treatments Light and Dark\nd3$tL <- ifelse(d3$Treatment == \"L\", 1, 0)\nd3$tD <- ifelse(d3$Treatment == \"D\", 1, 0)\n\n\n# Make data list\ndlist <- list(y = y, fish_id = coerce_index(d3$FishID), treatment = coerce_index(d3$Treatment),\n              light = d3$tL, dark = d3$tD)\n\n## Begin Experiment 2 Models: Barbelectomy Trials Only ##\n#------------------------------------------------------------------------\nm0b <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a,\n    a ~ dnorm(0, 1), \n    theta ~ dcauchy(0, 1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta = 1),\n  sample=TRUE , warmup=1000 , iter=1e4 , \n  cores=2 , chains=1 )\n\n# Fixed effects model: fish\n#------------------------------------------------------------------------\nm1b <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a_fish[fish_id],\n    a_fish[fish_id] ~ dnorm(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2 )\n\n# Varying intercepts: fish\n#------------------------------------------------------------------------\nm2b <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a_fish[fish_id],\n    a_fish[fish_id] ~ dnorm(a, sigma_fish),\n    a ~ dnorm(0, 1),\n    sigma_fish ~ dcauchy(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2 )\n\n# varying intercepts for fish by (fixed) treatment effect\n#------------------------------------------------------------------------\nm3b <- map2stan(\n  alist(\n    y ~ dbeta2( p, theta ),\n    logit(p) <- a + a_fish[fish_id] + b_treatment*treatment ,\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    a ~ dnorm(0, 1),\n    b_treatment ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0, 1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4, cores=2)\n\n# varying intercepts on fish and treatment\n#------------------------------------------------------------------------------------\nm4b <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    # linear model\n    logit(p) <- a + a_fish[fish_id] + b_treat[treatment],\n    # adaptive priors\n    a_fish[fish_id] ~ dnorm(0,sigma_fish),\n    b_treat[treatment] ~ dnorm(0, sigma_treat),\n    # fixed priors\n    a ~ dnorm(0, 1),\n    theta ~ dexp(1),\n    sigma_fish ~ dcauchy(0,1),\n    sigma_treat ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\n\n#------------------------------------------------------------------------\n# Varying intercepts and slopes by fish and treatment\n#-----------------------------\nm1bNC <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- (b_light + bl_fish[fish_id])*light + (b_dark + bd_fish[fish_id])*dark,\n    \n    # adaptive NON-CENTERED priors \n    c(bl_fish, bd_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    c(b_light, b_dark) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n\n# ------------------------------------------\n## Begin Model comparison for Barbel Trials\n# -----------------------------------------\ngst_models <- compare(m0b, m1b, m2b, m3b, m4b, m1bNC)\ngst_models # smaller WAIC indicates better out-of-sample estimated deviance. pWAIC = estimated effective number of parameters. m3b has the majority of the weight, but barely - basically, all the models that include treatment as a fixed effect are in the top 3.\n\nplot(gst_models) \n\n\n# compute predicted proportions for each case in data\npred3b <- sim(m3b)\n\n# to summarize\np3b <- apply( pred8b , 2, mean )\n\n\n# Plot raw data against simulated predicted points from one of the top models\nlibrary(ggplot2)\npar(mfrow = c(1,1))\n\nm3bcompare <- data.frame(observed = d3$PropPos, predicted = p3b)\nggplot(m3bcompare, aes(x = observed, y = predicted)) + geom_point() + geom_smooth() \n# model does not do as good a job predicting.\n\n\n#-------------------------------------------------------------------------------------------------\n## Begin Comparison of Barbels/Non Barbel Velocity Trials\n#------------------------------------------------------------------------\n\n## Load Data ##\n## Filter data to include only velocity trials (Treatments L and D), with or without barbels\n# d2b <- dplyr::filter(d, Treatment == \"L\" | Treatment == \"D\")\nlibrary(dplyr)\nd2b <- d[d$Treatment == \"L\" | d$Treatment == \"D\", ]\nlength(unique(d2b$FishID))\n\nwith <- filter(d, Type == \"with\")\nwithout <- filter(d, Type == \"without\")\n\n## Determine which fish were in both experiments 1 & 2\nFishwith <- as.data.frame(sort(unique(with$FishID))) \nFishwithout <- as.data.frame(sort(unique(without$FishID)))\nnames(Fishwith) <- \"FishID\"\nnames(Fishwithout) <- \"FishID\"\n\nreps <- semi_join(Fishwithout, Fishwith) #join for all values of x that are in y (Fishwithout that are in Fishwith)\nreps\nd2b <- filter(d2b, FishID %in% reps$FishID)\n\n## Create 0/1 indicator for barbels present (1) or absent (0)\nd2b$Barbels <- ifelse(d2b$Type == \"with\", 1, 0)\n# Create dummy variables for treatment\nd2b$tL <- ifelse(d2b$Treatment == \"L\", 1, 0)\nd2b$tD <- ifelse(d2b$Treatment == \"D\", 1, 0)\n\n## fix the one zero element\ny <- d2b$PropPos\nrange(y)\ny[y==0] <- 0.0001\nsum( dbeta2( y , 0.5 , 10 , log=TRUE ) )\nhead(d2b)\n\ndlistB <- list(y = y, fish_id = coerce_index(d2b$FishID), treatment = coerce_index(d2b$Treatment),\n               light = d2b$tL, dark = d2b$tD, barbels = d2b$Barbels)\n\n## Barbel Models (w/wo comparison) ##\n#------------------------------------------------------------------------\n\n# fishID only\nmB0 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id],\n    \n    a_fish[fish_id] ~ dnorm(a, sigma_fish),\n    a ~ dnorm(0, 1),\n    sigma_fish ~ dcauchy(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#------------------\n\n\n\n\n\n\n\n# varying intercepts with fish, fixed treatment effect\nmB1 <- map2stan(\n    alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + b_treatment*treatment ,\n    \n    # adaptive NON-CENTERED priors \n    a_fish[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    b_treatment ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#------------------------------------------------------------------------\n\n#  allowing treatment slope to vary by fish\nmB2 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + (b_treatment + b_fish[fish_id])*treatment ,\n    \n    # adaptive NON-CENTERED priors \n    c(a_fish, b_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    b_treatment ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n#------------------------------------------------------------------------\n\n#  varying intercepts on fish, individual treatment fixed effects\nmB3 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + b_light*light + b_dark*dark ,\n    \n    # adaptive NON-CENTERED priors \n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    \n    # fixed priors\n    c(b_light, b_dark) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#------------------------------------------------------------------------\n# Varying intercepts and slopes by fish and treatment\n#-----------------------------\nmB4 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + (b_light+ bl_fish[fish_id])*light + (b_dark + bd_fish[fish_id])*dark ,\n    # adaptive NON-CENTERED priors \n    c(a_fish, bl_fish, bd_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    c(b_light, b_dark) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n## Adding barbels as a fixed effect\nmB5 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + b_barbels*barbels ,\n    \n    # adaptive NON-CENTERED priors \n    a_fish[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    b_barbels ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#  Allowing barbels and treatment as fixed effects\n\nmB6 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + b_barbels*barbels + b_treatment*treatment,\n    \n    # adaptive NON-CENTERED priors \n    a_fish[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    c(b_barbels, b_treatment) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#  Allowing barbel effect slope to vary with treatment\n\nmB7 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + (b_barbels + b_treatment[treatment])*barbels ,\n    \n    # adaptive NON-CENTERED priors \n    a_fish[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    b_treatment[treatment] ~ dmvnormNC(sigma_treatment, Rho_treatment),\n    # fixed priors\n    b_barbels ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    c(sigma_fish, sigma_treatment) ~ dexp(1),\n    c(Rho_fish, Rho_treatment) ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\n\n#  Allowing barbel effect slope to vary with fish\nmB8 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- a_fish[fish_id] + (b_barbels + b_fish[fish_id])*barbels ,\n    \n    # adaptive NON-CENTERED priors \n    c(a_fish, b_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    \n    # fixed priors\n    b_barbels ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data = dlistB,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000, iter=1e4, cores=2)\nbeep(5)\n############################################################\n## Begin Barbel Trial/non-Barbel Trial Model Comparison\n############################################################\nbarbelmodels <- compare(mB0, mB1, mB2, mB3, mB4, mB5, mB6, mB7, mB8)\nbarbelmodels\n\n\np <- precis(mB7, prob = 0.95)\np <- data.frame(p@output)\np2 <- sapply(p[ , 1:4], rethinking::logistic)\nprecis(mB7, prob = 0.95)\np2\ndbfish <- filter(d, FishID %in% reps$FishID) # get fish in both experiments again\n\n# calculate mean & sd of response variable for Exp 1 for those fish\ndbfish %>% \n  filter(Treatment == \"D\" | Treatment == \"L\", Type == \"with\") %>% \n  summarise(mean = mean(PropPos), sd = sd(PropPos))\n\n# calculate mean & sd of response variable for Exp 2 for those fish\ndbfish %>% \n  filter(Treatment == \"D\" | Treatment == \"L\", Type == \"without\") %>% \n  summarise(mean = mean(PropPos), sd = sd(PropPos))\n\n# Plot Predictions Across Treatments\ngst_ensemble <- ensemble(mB5) \n# dummy data for predictions across treatments\nd.pred <- data.frame( Treatment <- c(\"L\", \"D\"))\n\n# build prediction ensemble of top 3 models\ngst_pensemble <- ensemble(mB5, mB6, mB8)\n\n# summarize\npred.ps <- apply(gst_pensemble$sim, 2, mean)\npred.ps.PI <- apply(gst_pensemble$sim, 2, PI)\n\nplot(0, 0, type = \"n\", xlab = \"Treatment\",\n     ylab = \"Proportion Positively Oriented\" , ylim = c(0,1), xaxt = \"n\" ,\n     xlim = c(1, 2))\naxis(1, at = 1:2, labels = c(\"L\", \"D\"))\n\np <- by(d2b$PropPos, \n        list(d2b$Treatment, d2b$FishID), mean ) # calculate the mean of PropPos for each combination of Treatment and FishID\n\nfor( FishID in 1:11)\n  lines(1:2, as.vector(p[,FishID]), col = rangi2)\n\n# Add prediction mean lines\nlines(1:44, pred.ps) # shows the average predicted proportion of positive rheotaxis, across treatments (sim)\nshade(pred.ps.PI, 1:44) #95% percentile interval of the mean prediction\ntitle(main = \"Simulated Predictions by Treatment, Averaging over the Posterior Distribution Top Model\")\n",
    "created" : 1472757511029.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "437521753",
    "id" : "9CAEAF6A",
    "lastKnownWriteTime" : 1473393155,
    "last_content_update" : 1473393155337,
    "path" : "~/Dropbox/GitHubRepos/gst_rheo/R/gst_rheo_Experiment2.R",
    "project_path" : "gst_rheo_Experiment2.R",
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}