{
    "collab_server" : "",
    "contents" : "## GST Rheotaxis Experiment 1: Velocity vs. Optimotor Belt Trials\n\n# Author: Myfanwy Johnston\n# Date: April 5, 2016\n# Note: all models were run with multiple chains the first time around\n\n# Lines 32-61: Data loading and preparation\n# Lines 62 - 242: Experimental Models\n# Lines 245 - 260: Model comparison\n# Lines 262 - end: Model exploration, prediction simulations, and visualizations\n\n# Required packages:\nlibrary(rethinking) # version 1.55\nlibrary(rstan) # version 2.9.0-3\nlibrary(beepr)\n# library(ggplot2) # Only need to load if you want to re-create my plots #\n# library(dplyr) # Alternatives to all but one dplyr method used are provided\n# library(grid)\n\n## Experiment 1\n\n# These data come from a total of 96 trials of juvenile green sturgeon rheotaxis (directionality in the face of perceived current). 23 fish underwent four different treatments under two different conditions. These were:\n#   \n#   Condition 1: velocity present, optimotor belt absent (48 of 96 trials)\n#   Condition 2: optimotor belt present, velocity not present (48 of 96 trials)\n# \n# Treatment A: optimotor belt placed above experimental tank, no velocity (24 trials)\n# Treatment B: optimotor belt placed below experimental tank, no velocity (24 trials)\n# Treatment L: velocity during the day (light) (24 trials)\n# Treatment D: velocity during the night (dark) (24 trials)\n# \n# The goal was to determine which treatment or condition had the greatest influence on proportion of time spent positively oriented (orienting nose-first into the current or visual \"current\").\n\n\n## Load Data ##\n#------------------------------------------------------------------------\n# d <- readxl::read_excel(\"../data_untidy/gst_rheo_all.xlsx\", na = \"NA\" )\nd <- read.csv(\"../data_tidy/gst_rheo_all.csv\", stringsAsFactors = FALSE, header = TRUE)\nhead(d)\n\n# Prep Data for Exp 1 Models\nd2 <- d[d$Type == \"with\", ] # filter trials from Experiment 1, where barbels were intact. 96 rows.\nd2$Velocity <- ifelse(d2$Treatment == \"L\" | d2$Treatment == \"D\", 1, 0) # Create dummy variable for velocity\n\n## There is one zero in the data; after running all models without this trial, we adjusted its value with the following code and ran models again; we found no difference in outcome.\n\ny <- d2$PropPos\ny[y==0] <- 0.0001 \nsum( dbeta2( y , 0.5 , 10 , log=TRUE ) ) #double-check that there are no zeros in the data\n\n## Assign dummy variables to columns in the dataframe\nd2$tA <- ifelse(d2$Treatment == \"A\", 1, 0)\nd2$tB <- ifelse(d2$Treatment == \"B\", 1, 0)\nd2$tL <- ifelse(d2$Treatment == \"L\", 1, 0)\nd2$tD <- ifelse(d2$Treatment == \"D\", 1, 0)\n\ndens(d2$PropPos) # See shape of raw data - highly bimodal\n\n# compile relevant predictors/variables into list for running models\ndlist <- list(y = y, fish_id = coerce_index(d2$FishID), vel = d2$Velocity, treatment = coerce_index(d2$Treatment),\n              above = d2$tA, below = d2$tB, light = d2$tL, dark = d2$tD)\n\n# Note: Models below are structured with single chains.  To check stationarity of HMC trace plots, run models with multiple chains (chains = n) in the constraints list first.\n\n## Intercept Model ##\n#------------------------------------------------------------------------\nm0 <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a,\n    a ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta = 1),\n  sample=TRUE , warmup=1000 , iter=1e4 , \n  cores=2 )\n\n\n# Fixed effects model: fish\n#------------------------------------------------------------------------\nm1 <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a_fish[fish_id],\n    a_fish[fish_id] ~ dnorm(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4, cores=2)\n\n# varying intercepts: fish\n#------------------------------------------------------------------------\nm2 <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a_fish[fish_id],\n    a_fish[fish_id] ~ dnorm(a, sigma_fish),\n    a ~ dnorm(0, 1),\n    sigma_fish ~ dcauchy(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\n\n# varying intercepts for fish by (fixed) treatment effect (single estimate for treatment)\n#------------------------------------------------------------------------\nm3 <- map2stan(\n  alist(\n    y ~ dbeta2( p, theta ),\n    logit(p) <- a + a_fish[fish_id] + b_treatment*treatment ,\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    a ~ dnorm(0, 1),\n    b_treatment ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\n\n# Varying intercepts on fish, fixed (individual) treatment effects:\n#------------------------------------------------------------------------\nm4 <- map2stan(\n  alist(\n    y ~ dbeta2(p,theta),\n    logit(p) <- a_fish[fish_id] + b_above*above + b_below*below + b_light*light + b_dark*dark, # can break them out separately like this so long as you've ommitted the global mean; if not, you have to have k-1 dummy variables.\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    c(b_above, b_below, b_light, b_dark) ~ dnorm(0, 1),\n    sigma_fish ~ dcauchy(0,1),\n    theta ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta = 1),\n  sample=TRUE , warmup=1000 , iter=1e4 , \n  cores=2, chains = 1 )\n\n# varying intercepts on fish and treatment (treatment as a mean, not individual)\n#------------------------------------------------------------------------------------\nm4.5 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    # linear model\n    logit(p) <- a + a_fish[fish_id] + a_treat[treatment],\n    # adaptive priors\n    a_fish[fish_id] ~ dnorm(0,sigma_fish),\n    a_treat[treatment] ~ dnorm(0, sigma_treat),\n    # fixed priors\n    a ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1),\n    sigma_treat ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\n\n\n#--------------------------------------------------\n# fish as varying intercepts, velocity as fixed effect\nm5 <- map2stan(\n  alist(\n    y ~ dbeta2( p, theta ),\n    logit(p) <- a + a_fish[fish_id] + b_velocity*vel,\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    a ~ dnorm(0, 1),\n    b_velocity ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\nbeep(0)\n\n## interestingly, if you just compare(m0, m1, m2, m3, m4, m4.5) up to this point, m4 is top-weighted. So even when the average effect of treatment (in general) is allowed to vary, individual fixed effects on treatment is better.  Suggests real individual treatment effect.  If you add m5, it splits the weight between the models that include treatment and/or velocity.  Between m4 and m5, no clear winner.  Which means that velocity might be as important as individual treatment.\n\n#------------------------------------------------------------------------------------\n# varying intercepts: fish and velocity\nm6 <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    # linear model\n    logit(p) <- a + a_fish[fish_id] + a_velocity[vel],\n    # adaptive priors\n    a_fish[fish_id] ~ dnorm(0,sigma_fish),\n    a_velocity[vel] ~ dnorm(0, sigma_vel),\n    # fixed priors\n    a ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1),\n    sigma_vel ~ dcauchy(0,1)\n  ),\n  data = dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\nbeep(2)\n#--------------------------------------------------\n# varying intercepts (fish) + fixed effect interaction model (fish X velocity)\nm7 <- map2stan(\n  alist(\n    y ~ dbeta2( p, theta ),\n    logit(p) <- a + a_fish[fish_id] + b_velocity*vel + bfXv*fish_id*vel,\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    a ~ dnorm(0, 1),\n    b_velocity ~ dnorm(0, 1),\n    bfXv ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1)\n  ),\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1) , warmup=1000 , iter=1e4 , cores=2)\n\n#---------\n# varying intercepts (fish) + fixed treatment correlation model (says that fish vary overall in positive orientation), but\n# everything else is constant across fish\n#----------------------------------------------------------------------------\nm8 <- map2stan(\n  alist(\n    #liklihood\n    y ~ dbeta2( p, theta ),\n    #linear model\n    logit(p) <- a_fish[fish_id] + (b_above*above + b_below*below)*a_velocity*vel + \n      (b_light*light + b_dark*dark)*b_velocity*vel,\n    #adaptive priors\n    a_fish[fish_id] ~ dnorm(0, sigma_fish),\n    \n    #fixed priors\n    c(b_above, b_below, a_velocity, b_light, b_dark, b_velocity) ~ dnorm(0, 1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dcauchy(0,1)\n  ),\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1) , warmup=1000 , iter=1e4 , cores=2, chains = 3)\n\n# Mixed model with varying intercepts on fish, varying slopes on fish/velocity\n#------------------------------------------------------------------------\nm1NC <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    # linear model\n    logit(p) <- a + a_fish[fish_id] + (b_velocity + b_fish)*vel,\n    # adaptive NON-CENTERED priors \n    c(a_fish, b_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    # fixed priors\n    c(a, b_velocity) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1) , warmup=1000 , iter=1e4 ,cores=2 )\n\n#------------------------------------------------------------------------\n# Varying intercepts and slopes by fish and treatment\n#-----------------------------\nm2NC <- map2stan(\n  alist(\n    #likelihood\n    y ~ dbeta2( p, theta ),\n    \n    # linear model\n    logit(p) <- (b_above + ba_fish[fish_id])*above + (b_below + bb_fish[fish_id])*below + \n      (b_light + bl_fish[fish_id])*light + (b_dark + bd_fish[fish_id])*dark,\n    \n    # adaptive NON-CENTERED priors \n    c(ba_fish, bb_fish, bl_fish, bd_fish)[fish_id] ~ dmvnormNC(sigma_fish, Rho_fish),\n    # fixed priors\n    c(b_above, b_below, b_light, b_dark) ~ dnorm(0,1),\n    theta ~ dcauchy(0,1),\n    sigma_fish ~ dexp(1),\n    Rho_fish ~ dlkjcorr(2)\n  ),\n  # data\n  data=dlist,\n  constraints=list(theta=\"lower=0\"),\n  start=list(theta=1), warmup=1000 , iter=1e4 , cores=2 )\nbeep(0)\n#---------------------------------\n# Begin Model comparison\n# -------------------------\ngst_models <- compare(m0, m1, m2, m3, m4, m4.5, m5, m6, m7, m8, m1NC, m2NC)\ngst_models # smaller WAIC indicates better out-of-sample estimated deviance. pWAIC = estimated effective number of parameters. \nplot(gst_models) # m2NC has by far the smallest out of sample estimated deviance.\n\nprecis(m2NC, prob = 0.95)\np <- precis(m2NC, prob = 0.95) # to convert this from log-odds to proportion (as in the manuscript text), take the logistic of coefficient estimates\n\nplot(precis(m2NC, pars = c(\"b_above\", \"b_below\", \"b_light\", \"b_dark\"), depth = 2)) #intercepts have much wider margins for treatments light & dark\n\npost <- extract.samples(m2NC)\ndens(post$sigma_fish, xlab = \"sigma\", xlim = c(0, 4)) # we can think of the sigma parameter for fish as a crude measure of the cluster's relevance for explaining the variation in the outcome - we observe bimodality in its density just as we observe bimodality in the raw data.\n\n\n#---------------------------------\n# Begin Model Exploration\n# -------------------------\n\n\n# Generate Predictions by Indiviudal Fish from Top Model\n#-----------------------------------------------------------\n# create dummy data for predictions across treatments\nd.pred <- data.frame(\n  Treatment = c(\"A\", \"B\", \"L\", \"D\"))\n\n# build prediction ensemble of top model\ngst_pensemble <- ensemble(m2NC)\n\n# summarize\npred.ps <- apply(gst_pensemble$sim, 2, mean) # items 48-72 = Treatment \"L\"\npred.ps.PI <- apply(gst_pensemble$sim, 2, PI)\n\n# create empty plot\nplot(0, 0, type = \"n\", xlab = \"Treatment\",\n     ylab = \"Proportion Positively Oriented\" , ylim = c(0,1), xaxt = \"n\" ,\n     xlim = c(1, 4))\naxis(1, at = 1:4, labels = c(\"A\", \"B\", \"L\", \"D\"))\n\n# calculate the mean of PropPos for each combination of Treatment and FishID\np <- by(d2$PropPos, \n        list(d2$Treatment, d2$FishID), mean ) \n\nfor( FishID in 1:23)\n  lines(1:4, as.vector(p[,FishID]), col = rangi2) #plot raw data\n\n# Add prediction mean lines\nlines(1:96, pred.ps) # shows the average predicted proportion of positive rheotaxis, across treatments (sim)\nshade(pred.ps.PI, 1:96) #95% percentile interval of the mean prediction\ntitle(main = \"Observed Data and Predicted Means for Positive Rheotaxis Across Treatments\")\n\n# there is still a lot of variation among individuals, although the model is supposed to account for this with the varying intercepts, but averages seem particularly bad at the \"L\" treatment, as most lines tick upwards for the \"L,\"; this is likely because no fish were near the actual mean, in the raw observations.  There is more uncertainty surrounding treatment A than B, as well.\n\n\nstr(post) # samples for the parameters are held in matrices. Treatments are in 1-dimensional matrices with 9000 rows.  For the fishxtreatment parameters, they're stored in matrices with 9000 rows each and 23 columns each.  Each column is a parameter, and each row is a sample from the posterior distribution.  So to plot the density for fish 1, we ask for all the rows from column 1:\n\ndens(post$ba_fish[, 1])\n\n# Plot individual fish\n\nfish <- 3\n\nd.pred <- list(\n  PropPos = rep(0, 4),\n  treatment = c(\"above\", \"below\", \"light\", \"dark\"),\n  fish_id = rep(fish, 4)\n)\n\nlink.m2NC <- link(m2NC)\n\n\n\n# compute predicted proportions for each case in data\n#------------------------------------------------------\npred <- sim(m2NC)\nstr(pred)\n\n# to summarize\npmv <- apply( pred , 2 , mean )\n# create empty plot\nplot(0, 0, type = \"n\", xlab = \"Treatment\",\n     ylab = \"Proportion Positively Oriented\" , ylim = c(0,1), xaxt = \"n\" ,\n     xlim = c(1, 4))\naxis(1, at = 1:4, labels = c(\"A\", \"B\", \"L\", \"D\"))\n\n\nd.pred <- data.frame(\"A\" = pmv[1:24], \"B\" = pmv[25:48], \"L\" = pmv[49:72], \"D\" = pmv[73:96])\nstr(d.pred)\n\npoints(d.pred$A, col = \"red\")\n\n\n# Plot raw data against simulated predicted points\nlibrary(ggplot2)\npar(mfrow = c(1,1))\n\nmcompare <- data.frame(observed = d2$PropPos, predicted = pmv)\nggplot(mcompare, aes(x = observed, y = predicted)) + geom_point() + geom_smooth(method = \"lm\") + ggtitle(\"m2NC: y ~ [fish_id] + b1[fish_id]*Above, etc\")\n\n# Draw Posterior density of m2NC\ndens(pmv, lty = 2, col = \"brown\", lwd = 1.5) # posterior predictions\ndens(d2$PropPos, add = TRUE, lwd = 1.5) # raw data\ntitle(\"Density of Observed Data vs. Posterior Predictions of Top Model\")\n\n# Plot Parameter Shapes\n#----------------------------------------------------------------\nlibrary(dplyr)\n# Extract Samples from Posterior\npost <- extract.samples(m2NC)\nstr(post)\n\n\n\n# Plot separately\ndens(treatl, lty = 2, xlim = c(0, 1), ylim = c(0, 3.5), lwd = 2, col = \"dodgerblue\", adj = 0.5)\ndens(treata, col = \"red\", ylim = c(0, 4), xlim = c(0, 1))\ndens(treatb, col = \"brown\", add = TRUE)\ndens(treatl, col = \"dodgerblue\", add = TRUE)\ndens(treatd, col = \"blue\", add = TRUE)\n# we can see the distinct distributions for the two conditions (velocity/nonvelocity).  Very distinct bi-modality; the model is capturing this aspect of the data very well.\n\n\n# extract simulated samples from posterior\nsim_A <- rnorm(1000, mean = post$b_above, sd = post$sigma_fish)\nsim_B <- rnorm(1000, post$b_below, post$sigma_fish)\nsim_L <- rnorm(1000, post$b_light, post$sigma_fish)\nsim_D <- rnorm(1000, post$b_dark, post$sigma_fish)\n\n# Calculate mean/sd/range\nmean(c(logistic(sim_A), logistic(sim_B)))\nsd(c(logistic(sim_A), logistic(sim_B)))\nmean(c(logistic(sim_L), logistic(sim_D)))\nsd(c(logistic(sim_L), logistic(sim_D)))\nrange(logistic(sim_B))\nrange(logistic(sim_D))\nrange(logistic(sim_L))\n\n# transform to a proportion and visualize\ndens(logistic(sim_D), col = \"Red\", xlab = \"Proportion Positive Rheotaxis\", ylim = c(0, 12), xlim = c(0, 1))\ndens(logistic(sim_L), add = TRUE, col = \"blue\")\ndens(logistic(sim_A), add = TRUE)\ndens(logistic(sim_B), add = TRUE, col = \"brown\")\ntitle('Simulated Proportion Time Positively Oriented by Treatment')\ntitle(sub = 'black = Above brown = Below red = Dark blue = Light')\n\nsim_A <- rnorm(24, mean = post$b_above, sd = post$sigma_fish)\ndens(logistic(sim_A))\nlibrary(dplyr)\ntA <- d2 %>% \n  filter(Treatment == \"A\") %>% \n  select(PropPos)\ndens(tA, lty = 2, add = TRUE)\n\n\n### Treatment Contrasts ###\ndiffLD <- logistic(post$b_dark) - logistic(post$b_light)\ndens(diffLD)\nmean(diffLD)\n\ndiffAB <- logistic(post$b_below) - logistic(post$b_above)\nmean(diffAB)\n\ndens(diffLD, col = \"blue\")\ndens(diffAB, add = TRUE, col = \"brown\")\n\nplot(diffLD, col = col.alpha(\"blue\"))\npoints(diffAB, col = col.alpha(\"brown\"), add = TRUE)\n\ndiffAL <- logistic(post$b_above) - logistic(post$b_light)\nmean(diffAL)\ndiffBL <- logistic(post$b_below) - logistic(post$b_light)\nmean(diffBL)\nplot(diffAL, col = col.alpha(\"yellow\"))\npoints(diffBL, col = col.alpha(\"green\"))\n\ndiffAD <- logistic(post$b_above) - logistic(post$b_dark)\nmean(diffAD)\ndiffBD <- logistic(post$b_below) - logistic(post$b_dark)\nmean(diffBD)\npoints(diffAD, col = col.alpha(\"dodgerblue\"))\npoints(diffBD, col = col.alpha(\"gray\"))\n\n## Summary of fixed effects\n\nmean(logistic(post$b_dark))\n\n\np <- precis(m2NC)\np2 <- data.frame(p@output)\np3 <- sapply(p2[,1:4], rethinking::logistic)\np3\n",
    "created" : 1472846081457.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2081555058",
    "id" : "49F96072",
    "lastKnownWriteTime" : 1473696856,
    "last_content_update" : 1473696856,
    "path" : "~/Dropbox/GitHubRepos/gst_rheo/R/gst_rheo_Experiment1.R",
    "project_path" : "gst_rheo_Experiment1.R",
    "properties" : {
    },
    "relative_order" : 7,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}